---
- name: Clone or pull application repository
  ansible.builtin.git:
    repo: 'https://github.com/Kelkaal/DevOps-Stage-6.git' # REPLACE with your actual repository URL
    dest: /home/ubuntu/DevOps-Stage-6
    version: master # or main, or a specific branch/tag
    accept_hostkey: yes
    force: yes # Use force to ensure checkout of the specified version

- name: Copy docker-compose.yml to the application directory
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../docker-compose.yml" # Path from playbook to project root docker-compose.yml
    dest: /home/ubuntu/DevOps-Stage-6/docker-compose.yml
    mode: '0644'

- name: Copy acme.json for Traefik certificates (if it exists)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../acme.json" # Path from playbook to project root acme.json
    dest: /home/ubuntu/DevOps-Stage-6/acme.json
    mode: '0600'
  ignore_errors: yes # This file might not exist on first deploy

- name: Build and start Docker containers
  community.docker.docker_compose:
    project_src: /home/ubuntu/DevOps-Stage-6
    build: yes
    state: present
  become: true # Run docker compose with root privileges